(function(e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e()}else if(typeof define==="function"&&define.amd){define([],e)}else{var n;if(typeof window!=="undefined"){n=window}else if(typeof global!=="undefined"){n=global}else if(typeof self!=="undefined"){n=self}else{n=this}n.Babelute=e()}})(function(){var e,n,r;return function e(n,r,t){function i(s,o){if(!r[s]){if(!n[s]){var l=typeof require=="function"&&require;if(!o&&l)return l(s,!0);if(u)return u(s,!0);var a=new Error("Cannot find module '"+s+"'");throw a.code="MODULE_NOT_FOUND",a}var c=r[s]={exports:{}};n[s][0].call(c.exports,function(e){var r=n[s][1][e];return i(r?r:e)},c,c.exports,e,n,r,t)}return r[s].exports}var u=typeof require=="function"&&require;for(var s=0;s<t.length;s++)i(t[s]);return i}({1:[function(e,n,r){var t=e("./lib/babelute");e("./lib/first-level-babelute");e("./lib/stringify");t.parser=e("./lib/parser");n.exports=t},{"./lib/babelute":2,"./lib/first-level-babelute":3,"./lib/parser":4,"./lib/stringify":5}],2:[function(e,n,r){var t=function(e){this.__babelute__="default";this._lexems=e||[]},i=t.Lexem=function(e,n,r,t){this.__babelutelexem__=true;this.lexic=e;this.name=n;this.args=r;if(t)this.handler=t},u=t.lexics={default:{Cl:t}},s=t.actions={default:{log:function(){console.log.apply(console,arguments)},debug:function(){console.log.apply(console,["debug:"].concat(arguments))},if:function(e,n,r){if(n[0])return n[1].$output(r,e);else if(n[2])return n[2].$output(r,e)},all:function(e,n,r){return Promise.all(n)},then:function(e,n,r){if(locals.error)return locals.result=args[0](locals.error);return locals.result=args[1](locals.result)},catch:function(e,n,r){if(locals.error)return locals.result=n[0](locals.error)}}};t.prototype={babelute:function(e){var n=t.getLexic(e),r=n.Cl,i=new r;i._lexems=this._lexems;return i},_new:function(e){return t.b(e||this.__babelute__!==true?this.__babelute__:null)},_append:function(e,n,r){this._lexems.push(new i(e||this.__babelute__,n,r));return this},_if:function(e,n){if(e)this._lexems=this._lexems.concat(n._lexems);return this},_use:function(e){if(!e)return this;var n=[].slice.call(arguments,1),r=typeof e==="string"?f(e):e;if(r.__babelute__)this._lexems=this._lexems.concat(r._lexems);else r(this._lexems,n);return this},forEach:function(e,n){var r=this._lexems;for(var t=0,i=r.length;t<i;++t)e.call(n||this,r[t],t)},_each:function(e,n,r){e.forEach(n,r||this);return this},_useEach:function(e){e.forEach(function(e){this._use(e)},this);return this},_translation:function(e){var n=t.getLexic(e),r=n.Cl,u=new r,s;for(var o=0,l=this._lexems.length;o<l;++o){s=this._lexems[o];var a=s.args.map(function(n){if(n&&n.__babelute__)return n._translation(e);return n});if(u[s.name])u[s.name].apply(u,a);else u._lexems.push(new i(s.lexic,s.name,a))}return u},$output:function(e,n,r,t){if(typeof e==="string")e=new c(e,r);var i=e.actions,u=this,o=t||0,l,a,f;while(l=this._lexems[o++]){if(i.__restrictions__&&!i.__restrictions__[l.lexic])continue;f=i[l.name]||s.default[l.name];if(f){a=f(n,l.args,e,e.scope);if(a&&a.then){return a.then(function(r){return u.$output(e,n,null,o)})}}}return n},if:function(e,n,r){return this._append(this.__babelute__,"if",[e,n,r])},log:function(){return this._append(this.__babelute__,"log",[].slice.call(arguments))},debug:function(){return this._append(this.__babelute__,"debug",[].slice.call(arguments))},all:function(){return this._append(this.__babelute__,"all",[].slice.call(arguments))},then:function(e,n){return this._append(this.__babelute__,"then",[e,n])},catch:function(e){return this._append(this.__babelute__,"fail",[e])}};t.b=function(e){return e?t.initializer(e):new t};function o(e,n){var r=e.Cl;e.initializer=e.initializer||{};e.initializer[n]=function(){var r=new e.Cl;return r[n].apply(r,[].slice.call(arguments))}}function l(e){e.initializer=e.initializer||{};Object.keys(e.Cl.prototype).forEach(function(n){if(n==="__babelute__"||n==="_lexems")return;o(e,n)});return e.initializer}t.initializer=function(e){var n=t.getLexic(e);return n.initializer||l(n)};t.getLexic=function(e){var n=u[e];if(!n)throw new Error("Babelute : lexic not found : "+e);return n};t.getActions=function(e){var n=s[e];if(!n)throw new Error("Babelute : actions not found : "+e);return n};t.toLexic=function(e,n,r){var i=u[e]||p(e);if(typeof n==="object"){if(n.forEach){n.forEach(function(n){a(i,e,n)})}else for(var s in n){if(s==="__babelute__"||s==="_lexems")continue;a(i,e,s,n[s])}}else a(i,e,n,r);return t};function a(e,n,r,t){var i=e.FirstLevelCl.prototype;i[r]=h(n,r);e.Cl.prototype[r]=t||i[r];o(e,r)}t.toActions=function(e,n,r){var i=s[e]=s[e]||{};if(typeof n==="object"){for(var u in n){if(u==="__restrictions__"){i.__restrictions__=i.__restrictions__||{};for(var o in n[u])i[u][o]=n[u][o]}else i[u]=n[u]}}else if(n==="__restrictions__"){i.__restrictions__=i.__restrictions__||{};for(var o in r)i.__restrictions__[o]=r[o]}else i[n]=r;return t};t.extendLexic=function(e,n,r){var i=t.getLexic(e),u=p(n,i);if(r)t.toLexic(n,r);return t};t.extendActions=function(e,n,r){t.toActions(n,t.getActions(e));if(r)t.toActions(n,r);var i=s[n];i.__restrictions__=i.__restrictions__||{};i.__restrictions__[n]=true;return t};function c(e,n){this.__babelute__env__=true;this.actions=t.getActions(e);this.scope=n||null}c.prototype={pushScope:function(e,n){this.scopes=this.scopes||[];var r={};for(var t in this.scope)r[t]=this.scope[t];r[t]=n;this.scopes.push(r);this.scope=r},popScope:function(e){if(!this.scopes)return;if(this.scopes.length)this.scopes.pop();this.scope=this.scopes[this.scopes.length-1]||null}};function f(e){var n=e.split(":"),r=n[0],i=t.getLexic(r),u=n[1];if(!i.Cl.prototype[u])throw new Error("Babelute : method not found : "+e);var s=_(r,i);return function(e,n){s._lexems=e;s[u].apply(s,n)}}function _(e,n){if(n.Instance)return n.Instance;var r=n.Cl;return n.Instance=new r}function p(e,n){var r=n&&n.Cl||t,i=n&&n.FirstLevelCl||t;var s=function(){r.call(this);this.__babelute__=e};s.prototype=new r;var l=function(){i.call(this);this.__babelute__=e};l.prototype=new i;lexic=u[e]={Cl:s,FirstLevelCl:l};if(n){var a=n.initializer,c=t.initializer(e);for(var f in a){if(f==="__babelute__"||f==="_lexems")continue;o(lexic,f)}}return lexic}function h(e,n){return function(){return this._append(e,n,[].slice.call(arguments))}}t.initLexic=p;t.Environment=c;n.exports=t},{}],3:[function(e,n,r){var t=e("./babelute");var i=function(){t.call(this)};i.prototype=new t;i.prototype.babelute=function(e){var n=t.getLexic(e),r=n.FirstLevelCl,i=new r;i._lexems=this._lexems;return i};t.firstLevelInitializer=i.initializer=function(e){var n=t.getLexic(e).FirstLevelCl;return lexic.FirstLevelInitializer||(lexic.FirstLevelInitializer=function(){return new n})};t.firstLevel=function(e){if(e)return i.initializer(e)();return new i};n.exports=i},{"./babelute":2}],4:[function(e,n,r){function t(e,n){var r=e[n];if(!r)throw new Error("Babelute : no lexem found in current lexic ("+(e.__babelute__||"default")+") with :"+n);return r}var i=e("elenpi/v2"),u=i.r,s=i.Parser,o=e("./babelute"),l=/\\'/g,a=/\\"/g,c={1:"number",2:"number",3:"number",4:"number",5:"number",6:"number",7:"number",8:"number",9:"number",0:"number","'":"singlestring",'"':"doublestring","{":"object","[":"array"},f={babelute:u().space().oneOrMore({rule:"lexem",separator:u().terminal(/^\s*/),pushTo:function(e,n,r){if(r.lexic&&r.lexic!==e.currentLexic){if(n.__swapped__)e.lexics[e.lexics.length-1]=e.lexic;else e.lexics.push(r.lexic);e.currentLexic=r.lexic;var i=o.b(r.lexic);i._lexems=n._lexems;n.__swapped__=i}else if(e.asDoc)(n.__swapped__||n)._append(e.currentLexic,r.name,r.args);else{n=n.__swapped__||n;t(n,r.name).apply(n,r.args)}}}).done(function(e,n){if(n.__swapped__){e.lexics.pop();e.currentLexic=e.lexics[e.lexics.length-1];n.__swapped__=null}}).space(),lexem:u().oneOf(u().terminal(/^([\w-_]+)\s*\(\s*/,function(e,n,r){n.name=r[1];n.args=[]}).oneOf(u().terminal(/^\s*\)/),u().oneOrMore({rule:"value",separator:u().terminal(/^\s*,\s*/),pushTo:function(e,n,r){n.args.push(r.value)}}).terminal(/^\s*\)/)),u().terminal(/^#([\w-_]+):/,function(e,n,r){n.lexic=r[1]})),value:u().done(function(e,n){if(!e.string.length){e.error=true;return}e.parser.exec(c[e.string[0]]||"wordValue",n,e)}),number:u().terminal(/^[0-9]+(\.[0-9]+)?/,function(e,n,r){n.value=r[1]?parseFloat(r[0]+r[1],10):parseInt(r[0],10)}),singlestring:u().terminal(/^'((?:\\'|[^'])*)'/,function(e,n,r){n.value=r[1].replace(l,"'")}),doublestring:u().terminal(/^"((?:\\"|[^"])*)"/,function(e,n,r){n.value=r[1].replace(a,'"')}),wordValue:u().oneOf(u().terminal(/^(?:true|false|null|undefined|NaN|Infinity)/,function(e,n,r){switch(r[0]){case"true":n.value=true;break;case"false":n.value=false;break;case"null":n.value=null;break;case"undefined":n.value=undefined;break;case"NaN":n.value=NaN;break;case"Infinity":n.value=Infinity;break}}),u().one({rule:"function",set:function(e,n,r){if(e.acceptFunctions)n.value=Function.apply(null,r.args.concat(r.block))}}),u().one({rule:"babelute",as:function(e,n){return e.asDoc?o.doc(e.currentLexic):o.b(e.currentLexic)},set:function(e,n,r){n.value=r}})),object:u().one({rule:u().terminal(/^\{\s*/).zeroOrMore({rule:u().terminal(/^([\w-_]+)|"([^"]*)"|'([^']*)'/,function(e,n,r){n.key=r[1]}).terminal(/^\s*:\s*/).one("value"),separator:u().terminal(/^\s*,\s*/),pushTo:function(e,n,r){n[r.key]=r.value}}).terminal(/^\s*\}/),set:function(e,n,r){n.value=r}}),array:u().one({rule:u().terminal(/^\[\s*/).zeroOrMore({rule:"value",separator:u().terminal(/^\s*,\s*/),pushTo:function(e,n,r){n.push(r.value)}}).terminal(/^\s*\]/),as:function(){return[]},set:function(e,n,r){n.value=r}}),function:u().terminal(/^function\s*\(\s*/,function(e,n,r){n.args=[];n.block=""}).zeroOrMore({rule:u().terminal(/^[\w-_]+/,"key"),separator:u().terminal(/^\s*,\s*/),pushTo:function(e,n,r){n.args.push(r.key)}}).terminal(/^\s*\)\s*\{/).one("scopeBlock").done(function(e,n){n.block=n.block.substring(0,n.block.length-1)}),scopeBlock:u().oneOf(u().terminal(/^[^\{\}]*\{/,function(e,n,r){n.block+=r[0]}).oneOrMore("scopeBlock"),u().terminal(/^[^\}]*\}/,function(e,n,r){n.block+=r[0]}))};o.Parser=s;var _=new s(f,"babelute"),p={};o.parse=function(e,n){n=n||{};var r={};for(var t in n)r[t]=n[t];r.lexics=[n.mainLexic];r.currentLexic=n.mainLexic;return _.parse(e,"babelute",o.b(n.mainLexic),r)};o.fromJSON=function(e){return JSON.parse(e,function(e,n){if(!n)return n;if(n.__babelutelexem__)return new o.Lexem(n.lexic,n.name,n.args);if(n.__babelute__){var r=new o;r._lexems=n._lexems;return r}return n})};n.exports=_},{"./babelute":2,"elenpi/v2":6}],5:[function(e,n,r){var t=e("./babelute");function i(e,n,r){if(r)e.lexicScope[e.lexicScope.length-1]=n;else e.lexicScope.push(n);e.currentLexic=n;return true}function u(e){e.lexicScope.pop();e.currentLexic=e.lexicScope[e.lexicScope.length-1]}function s(e){var n=e.length,r=n;while(n&&e[n-1]===undefined)n--;if(n<r)e.splice(n,r-n);return e}function o(e,n){var r=[],t=0,o,l,c=false,f;for(var _=0,p=e.length;_<p;++_){o=e[_];if(o.lexic!==n.currentLexic){f="#"+o.lexic+":";r.push(f);c=i(n,o.lexic,c)}if(o.args){l=a(s(o.args),n);if((o.args.length>1||o.args[0]&&o.args[0].__babelute__)&&l.length>n.maxLength)f=o.name+"(\n\t"+l.replace(/\n/g,function(e){return e+"\t"})+"\n)";else f=o.name+"("+l+")"}else f=o.name+"()";r.push(f);t+=f.length}if(c)u(n);t+=e.length-1;return r.join(t>n.maxLength?"\n":" ")}function l(e,n){var r,t,i=e.length;if(!i)return"[]";r=a(e,n);t=i>1&&r.length>n.maxLength;if(t)return"[\n\t"+r.replace(/\n/g,function(e){return e+"\t"})+"\n]";return"["+r+"]"}function a(e,n){var r=e.length;if(!r)return"";var t,i=[],u=0;for(var s=0;s<r;++s){t=_(e[s],n);i.push(t);u+=t.length}u+=r-1;return i.join(u>n.maxLength?",\n":", ")}function c(e,n){var r,t;var i=Object.keys(e);r=f(e,i,n);if(i.length>1&&r.length>n.maxLength){return"{\n\t"+r.replace(/\n/g,function(e){return e+"\t"})+"\n}"}return"{ "+r+" }"}function f(e,n,r){var t,i=[],u=0,s;for(var o=0,l=n.length;o<l;++o){s=n[o];t=_(e[s],r);u+=t.length;i.push(s+": "+t)}u+=n.length-1;return u>r.maxLength?i.join(",\n"):i.join(", ")}function _(e,n){if(!e)return e+"";switch(typeof e){case"object":if(e.__babelute__)return e._stringify(n);if(e.forEach)return n.beautify?l(e,n):"["+p(e,n)+"]";return n.beautify?c(e,n):h(e,n);case"string":return JSON.stringify(e);case"function":var r=(e+"").replace(/anonymous/,"").replace(/\n\/\*\*\//,"");return n.beautify?r:r.replace(/`[^`]*`|\n\s*/g,function(e){return e[0]==="`"?e:" "});default:return e+""}}function p(e,n){if(!e.length)return"";var r="";for(var t=0,i=e.length;t<i;++t)r+=(t?",":"")+_(e[t],n);return r}function h(e,n){var r=Object.keys(e),t="",i;for(var u=0,s=r.length;u<s;++u){i=r[u];t+=(u?",":"")+i+":"+_(e[i],n)}return"{"+t+"}"}t.prototype.toString=function(){return this._stringify()};t.prototype._stringify=function(e){e=e||{};e.lexicScope=e.lexicScope||[];if(e.beautify){e.maxLength=e.maxLength||20;return o(this._lexems,e)}var n=this._lexems,r="",t,l=false;for(var a=0,c=n.length;a<c;++a){t=n[a];if(t.lexic!==e.currentLexic){r+="#"+t.lexic+":";l=i(e,t.lexic,l)}r+=t.name+"("+(t.args?p(s(t.args),e):"")+")"}if(l)u(e);return r};t.arrayToString=p;t.objectToString=h;t.valueToString=_},{"./babelute":2}],6:[function(e,n,r){(function(){var e=/^[\s\n\r]+/;function r(e,n,i){if(i.stop||i.error)return;if(typeof e==="string")e=t(i.parser,e);var u=e._queue,s;for(var o=0,l=u.length;o<l;++o){s=u[o];if(s.__elenpi__)r(s,n,i);else s(i,n);if(i.error)return;if(i.soFar>i.string.length)i.soFar=i.string.length;if(i.stop)return}}function t(e,n){var r=e.rules[n];if(!r)throw new Error("elenpi : rules not found : "+rule);return r}function i(){this._queue=[];this.__elenpi__=true}i.prototype={done:function(e){this._queue.push(e);return this},log:function(e){e=e||"";return this.done(function(n,r){console.log("elenpi log : ",e,n,r)})},use:function(e){var n=[].slice.call(arguments,1);return this.done(function(u,s){if(typeof e==="string")e=t(u.parser,e);if(e.__elenpi__){r(e,s,u);return}var o=new i;e.apply(o,n);r(o,s,u)})},optional:function(e){return this.done(function(n,t){var i=n.string;r(e,t,n);if(n.error){n.string=i;n.error=false}})},terminal:function(e,n){return this.done(function(r,t){if(!r.string.length){r.error=true;return}var i=e.exec(r.string);if(i){r.string=r.string.substring(i[0].length);if(n){if(typeof n==="string")t[n]=i[0];else n(r,t,i)}return}r.error=true})},char:function(e){return this.done(function(n,r){if(!n.string.length||n.string[0]!==e)n.error=true;else n.string=n.string.substring(1)})},xOrMore:function(e){var n=typeof e==="string"||e.__elenpi__?{rule:e}:e;n.minimum=n.minimum||0;n.maximum=n.maximum||Infinity;return this.done(function(e,t){var i=n;if(!e.string.length&&i.minimum>0){e.error=true;return}var u=e.string,s=0,o=i.rule,l=i.pushTo,a=typeof l==="string",c=i.as,f=i.separator,_;while(!e.error&&e.string.length&&s<i.maximum){_=c?c(e,t):l?{}:t;r(o,_,e);if(e.error)break;s++;if(!_.skip&&l)if(a){t[l]=t[l]||[];t[l].push(_)}else l(e,t,_);if(f&&e.string.length)r(f,_,e)}e.error=s<i.minimum;if(!s)e.string=u})},zeroOrMore:function(e){return this.xOrMore(e)},oneOrMore:function(e){if(typeof e==="string"||e.__elenpi__)e={rule:e,minimum:1};return this.xOrMore(e)},zeroOrOne:function(e){var n=typeof e==="string"||e.__elenpi__?{rule:e}:e;return this.done(function(e,t){if(!e.string.length)return;var i=n.as?n.as(e,t):n.set?{}:t;var u=e.string;r(n.rule,i,e);if(!e.error){if(!i.skip&&n.set){if(typeof n.set==="string")t[n.set]=i;else n.set(e,t,i)}return}e.string=u;e.error=false})},oneOf:function(e){var n=typeof e==="string"||e.__elenpi__?{rules:[].slice.call(arguments)}:e;return this.done(function(e,t){if(!e.string.length){e.error=true;return}var i=n,u=0,s=i.rules.length,o,l,a=e.string;while(u<s){o=i.rules[u];u++;l=i.as?i.as(e,t):i.set?{}:t;r(o,l,e);if(!e.error){if(!l.skip&&i.set){if(typeof i.set==="string")t[i.set]=l;else i.set(e,t,l)}return}e.error=false;e.string=a}e.error=true})},one:function(e){var n=typeof e==="string"||e&&e.__elenpi__?{rule:e}:e;return this.done(function(e,t){if(!e.string.length){e.error=true;return}var i=n,u=i.as?i.as(e,t):i.set?{}:t;r(i.rule,u,e);if(!e.error&&!u.skip&&i.set){if(typeof i.set==="string")t[i.set]=u;else i.set(e,t,u)}})},skip:function(){return this.done(function(e,n){n.skip=true})},space:function(n){return this.done(function(r,t){if(!r.string.length){if(n)r.error=true;return}var i=(r.parser.rules.space||e).exec(r.string);if(i)r.string=r.string.substring(i[0].length);else if(n)r.error=true})},end:function(e){return this.done(function(n,r){if(!n.string.length)n.stop=true;else if(e)n.error=true})}};var u=function(e,n){this.rules=e;this.defaultRule=n};u.prototype={exec:function(e,n,t){r(e,n,t)},parse:function(e,n,t,i){i=i||{};t=t||{};i.parser=this;i.soFar=Infinity;i.string=e;if(!n)n=this.rules[this.defaultRule];r(n,t,i);if(i.error||i.string.length){var u=e.length-i.soFar;console.error("elenpi parsing failed : (pos:"+u+") near :\n",e.substring(Math.max(u-1,0),u+50));return false}return t}};var s={r:function(){return new i},Rule:i,Parser:u};if(typeof n!=="undefined"&&n.exports)n.exports=s;else this.elenpi=s})()},{}]},{},[1])(1)});
